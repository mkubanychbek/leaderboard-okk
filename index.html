<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‚ö° Service Speed League</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;800;900&family=Barlow:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --sky-top: #C8E6F5;
  --sky-bot: #E8F4FD;
  --asphalt: #3A3D42;
  --asphalt-light: #4E5157;
  --grass: #6BBF4E;
  --grass-dark: #4F9A36;
  --white-line: #F5F0E8;
  --barrier-red: #D63B2F;
  --barrier-white: #F0EEE8;
  --panel-bg: rgba(255,255,255,0.94);
  --panel-border: rgba(0,0,0,0.10);
  --shadow: rgba(0,0,0,0.18);
  --gold: #E8A000;
  --silver: #8A9BA8;
  --bronze: #A0622A;
  --accent: #D63B2F;
  --text-dark: #1A1C1E;
  --text-mid: #4A4E54;
  --text-light: #7A808A;
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  background: linear-gradient(180deg, var(--sky-top) 0%, var(--sky-bot) 100%);
  font-family: 'Barlow Condensed', sans-serif;
  width: 100vw; height: 100vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  position: relative;
}

/* ‚îÄ‚îÄ‚îÄ SKY CLOUDS ‚îÄ‚îÄ‚îÄ */
.clouds {
  position: fixed;
  top: 0; left: 0; right: 0;
  height: 120px;
  pointer-events: none;
  z-index: 0;
  overflow: hidden;
}
.cloud {
  position: absolute;
  background: rgba(255,255,255,0.85);
  border-radius: 60px;
  animation: cloudDrift linear infinite;
}
.cloud::before, .cloud::after {
  content:'';
  position: absolute;
  background: rgba(255,255,255,0.85);
  border-radius: 50%;
}

/* ‚îÄ‚îÄ‚îÄ CONFIG OVERLAY ‚îÄ‚îÄ‚îÄ */
.config-overlay {
  position: fixed; inset: 0;
  background: rgba(30,35,40,0.55);
  backdrop-filter: blur(4px);
  z-index: 900;
  display: flex;
  align-items: center;
  justify-content: center;
}
.config-box {
  background: #fff;
  border-radius: 20px;
  padding: 40px 44px;
  width: min(520px, 92vw);
  box-shadow: 0 20px 60px rgba(0,0,0,0.25);
}
.config-box h2 {
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 26px;
  font-weight: 900;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--text-dark);
  margin-bottom: 6px;
}
.config-box .sub {
  font-size: 13px;
  color: var(--text-light);
  margin-bottom: 28px;
  font-family: 'Barlow', sans-serif;
}
.form-group { margin-bottom: 18px; }
.form-group label {
  display: block;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.15em;
  color: var(--text-mid);
  margin-bottom: 7px;
}
.form-group input, .form-group select {
  width: 100%;
  border: 1.5px solid #D8DDE4;
  border-radius: 10px;
  padding: 11px 14px;
  font-family: 'Barlow', sans-serif;
  font-size: 14px;
  color: var(--text-dark);
  outline: none;
  transition: border-color 0.15s;
  background: #FAFBFC;
}
.form-group input:focus, .form-group select:focus {
  border-color: var(--accent);
  background: #fff;
}
.form-group input::placeholder { color: #B0B8C4; }
.form-hint {
  font-family: 'Barlow', sans-serif;
  font-size: 11px;
  color: var(--text-light);
  margin-top: 5px;
  line-height: 1.55;
}
.config-box .error {
  color: var(--accent);
  font-size: 12px;
  font-family: 'Barlow', sans-serif;
  margin-top: 4px;
  display: none;
}
.btn-primary {
  width: 100%;
  padding: 14px;
  background: var(--accent);
  border: none;
  border-radius: 10px;
  color: #fff;
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 17px;
  font-weight: 800;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  cursor: pointer;
  transition: background 0.15s, transform 0.1s;
  margin-top: 6px;
}
.btn-primary:hover { background: #bf2e24; transform: translateY(-1px); }
.btn-secondary {
  width: 100%;
  padding: 10px;
  background: transparent;
  border: 1.5px solid #D8DDE4;
  border-radius: 10px;
  color: var(--text-light);
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 14px;
  font-weight: 600;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  cursor: pointer;
  margin-top: 8px;
  transition: all 0.15s;
}
.btn-secondary:hover { border-color: var(--text-mid); color: var(--text-mid); }

/* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
.header {
  position: relative; z-index: 10;
  background: var(--accent);
  padding: 10px 36px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  box-shadow: 0 3px 16px rgba(214,59,47,0.35);
  display: none;
}
.header-left { display: flex; align-items: center; gap: 14px; }
.rally-flag {
  font-size: 28px;
  line-height: 1;
  filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
}
.header-title {
  font-size: clamp(20px, 2.8vw, 36px);
  font-weight: 900;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: #fff;
  text-shadow: 0 2px 6px rgba(0,0,0,0.2);
}
.header-sub {
  font-size: clamp(10px, 1vw, 13px);
  color: rgba(255,255,255,0.75);
  letter-spacing: 0.15em;
  text-transform: uppercase;
  margin-top: 2px;
  font-family: 'Barlow', sans-serif;
}
.header-right {
  display: flex;
  align-items: center;
  gap: 24px;
  font-size: 12px;
  color: rgba(255,255,255,0.85);
  font-family: 'Barlow', sans-serif;
}
.live-badge {
  background: rgba(255,255,255,0.2);
  border: 1px solid rgba(255,255,255,0.35);
  border-radius: 20px;
  padding: 4px 12px;
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 0.1em;
  text-transform: uppercase;
}
.live-dot {
  width: 7px; height: 7px;
  border-radius: 50%;
  background: #7FFF7F;
  box-shadow: 0 0 6px #7FFF7F;
  animation: blink 1.1s step-end infinite;
}
@keyframes blink { 50%{opacity:0;} }

/* ‚îÄ‚îÄ‚îÄ TRACK AREA ‚îÄ‚îÄ‚îÄ */
.track-area {
  position: relative; z-index: 5;
  flex: 1;
  padding: 10px 36px 6px;
  display: flex;
  flex-direction: column;
  gap: 5px;
  overflow-y: auto;
  overflow-x: hidden;
  scrollbar-width: none;
  display: none;
}

/* ‚îÄ‚îÄ‚îÄ LANE ‚îÄ‚îÄ‚îÄ */
.race-lane {
  position: relative;
  flex: 1;
  min-height: 36px;
  max-height: 60px;
  display: flex;
  align-items: stretch;
}

/* Grass strip top+bottom */
.lane-grass-top, .lane-grass-bot {
  position: absolute;
  left: 0; right: 0;
  height: 5px;
}
.lane-grass-top { top: 0; background: linear-gradient(90deg, var(--grass-dark), var(--grass) 30%, var(--grass-dark) 70%, var(--grass)); }
.lane-grass-bot { bottom: 0; background: linear-gradient(90deg, var(--grass) 30%, var(--grass-dark) 70%); }

/* Asphalt surface */
.track-surface {
  position: absolute;
  left: 0; right: 0;
  top: 5px; bottom: 5px;
  background: var(--asphalt);
  overflow: hidden;
}
/* Road texture: subtle lighter patches */
.track-surface::before {
  content:'';
  position: absolute; inset: 0;
  background: repeating-linear-gradient(
    90deg,
    transparent 0px,
    transparent 38px,
    var(--asphalt-light) 38px,
    var(--asphalt-light) 39px
  );
  animation: roadScroll 0.7s linear infinite;
}
@keyframes roadScroll {
  from { background-position: 0 0; }
  to   { background-position: -39px 0; }
}
/* Center dashed line */
.road-dashes {
  position: absolute;
  top: 50%; transform: translateY(-50%);
  left: 0; right: 0;
  height: 3px;
  background: repeating-linear-gradient(
    90deg,
    var(--white-line) 0px,
    var(--white-line) 22px,
    transparent 22px,
    transparent 44px
  );
  opacity: 0.18;
  animation: dashScroll 0.7s linear infinite;
}
@keyframes dashScroll {
  from { background-position: 0 0; }
  to   { background-position: -44px 0; }
}

/* Crash barriers (left side) */
.barrier {
  position: absolute;
  left: 300px;
  top: 5px; bottom: 5px;
  width: 10px;
  background: repeating-linear-gradient(
    0deg,
    var(--barrier-red) 0px,
    var(--barrier-red) 8px,
    var(--barrier-white) 8px,
    var(--barrier-white) 16px
  );
  border-right: 2px solid rgba(0,0,0,0.15);
  z-index: 8;
}

/* Finish banner */
.finish-zone {
  position: absolute;
  right: 148px;
  top: 5px; bottom: 5px;
  width: 28px;
  z-index: 8;
}
.finish-checker {
  width: 100%; height: 100%;
  background: repeating-conic-gradient(#fff 0% 25%, #111 0% 50%) 0 0 / 14px 14px;
  opacity: 0.92;
  border-left: 2px solid rgba(0,0,0,0.3);
  border-right: 2px solid rgba(0,0,0,0.3);
}
.finish-glow {
  position: absolute;
  inset: 0;
  background: rgba(255,255,255,0.12);
}

/* Left panel: rank + name */
.lane-left {
  position: absolute;
  left: 0; top: 0; bottom: 0;
  width: 300px;
  z-index: 12;
  background: var(--panel-bg);
  border-right: 2px solid var(--panel-border);
  display: flex;
  align-items: center;
  padding: 0 10px 0 8px;
  gap: 8px;
  box-shadow: 3px 0 10px rgba(0,0,0,0.08);
}

/* Rank number plate */
.rank-plate {
  width: 40px; height: 36px;
  border-radius: 7px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: clamp(14px, 1.8vw, 22px);
  font-weight: 900;
  letter-spacing: -0.02em;
  flex-shrink: 0;
}
.rank-plate.pos-1 { background: #FFF0C0; color: var(--gold); border: 2px solid #E8C84A; }
.rank-plate.pos-2 { background: #EDF1F4; color: var(--silver); border: 2px solid #B0BCC6; }
.rank-plate.pos-3 { background: #F5E8DC; color: var(--bronze); border: 2px solid #C08050; }
.rank-plate.pos-other { background: #F0F2F4; color: var(--text-mid); border: 2px solid #D0D5DB; font-size: clamp(11px,1.4vw,17px); }

.op-name {
  font-size: clamp(10px, 1.15vw, 14px);
  font-weight: 700;
  color: var(--text-dark);
  text-transform: uppercase;
  letter-spacing: 0.02em;
  white-space: normal;
  overflow: hidden;
  line-height: 1.15;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}
.op-dept {
  font-family: 'Barlow', sans-serif;
  font-size: 10px;
  color: var(--text-light);
  margin-top: 1px;
}

/* Right panel: score */
.lane-right {
  position: absolute;
  right: 0; top: 0; bottom: 0;
  width: 148px;
  z-index: 12;
  background: var(--panel-bg);
  border-left: 2px solid var(--panel-border);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 2px;
  box-shadow: -3px 0 10px rgba(0,0,0,0.08);
}
.score-num {
  font-size: clamp(17px, 2vw, 28px);
  font-weight: 900;
  letter-spacing: -0.01em;
  color: var(--text-dark);
  line-height: 1;
  transition: color 0.6s;
}
.score-bar-wrap {
  width: 100px;
  height: 5px;
  background: #E0E4E9;
  border-radius: 3px;
  overflow: hidden;
}
.score-bar-fill {
  height: 100%;
  border-radius: 3px;
  transition: width 1s ease, background 0.6s;
}
.score-label {
  font-family: 'Barlow', sans-serif;
  font-size: 10px;
  color: var(--text-light);
  letter-spacing: 0.08em;
  text-transform: uppercase;
}

/* ‚îÄ‚îÄ‚îÄ CAR WRAPPER ‚îÄ‚îÄ‚îÄ */
.car-wrapper {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  z-index: 20;
  transition: left 1.3s cubic-bezier(0.22, 0.8, 0.36, 1);
  pointer-events: none;
}

/* Idle wobble on finish */
.car-idle .car-body {
  animation: idleWobble 0.5s ease-in-out infinite alternate;
  transform-origin: center bottom;
}
@keyframes idleWobble {
  0%   { transform: translateY(0px)  rotate(-0.8deg) scaleY(1.00); }
  100% { transform: translateY(-3px) rotate(0.8deg)  scaleY(0.97); }
}

/* Wheel spin */
.wheel-spin { animation: wheelSpin 0.25s linear infinite; transform-origin: center; }

/* Dust trail */
.dust-trail {
  position: absolute;
  left: -8px;
  top: 50%;
  transform: translateY(-50%);
  display: flex;
  gap: 4px;
  align-items: center;
  pointer-events: none;
}
.dust {
  border-radius: 50%;
  background: rgba(120,100,80,0.45);
  animation: dustAnim 0.5s ease-out infinite;
}
.dust:nth-child(1) { width:10px;height:8px; animation-delay:0s; }
.dust:nth-child(2) { width:7px;height:6px; animation-delay:0.12s; background:rgba(120,100,80,0.3); }
.dust:nth-child(3) { width:5px;height:4px; animation-delay:0.24s; background:rgba(120,100,80,0.18); }
@keyframes dustAnim {
  0%   { transform:translateX(0) scale(1); opacity:0.8; }
  100% { transform:translateX(-22px) scale(0.2); opacity:0; }
}

/* Speed blur overlay on car when moving */
.car-wrapper.is-moving .car-body {
  filter: blur(0.5px) drop-shadow(3px 0 4px rgba(0,0,0,0.25));
}

/* Rank-up/down badge */
.rank-delta {
  position: absolute;
  right: 152px;
  font-size: 12px;
  font-weight: 800;
  font-family: 'Barlow Condensed', sans-serif;
  letter-spacing: 0.05em;
  animation: deltaAnim 2.2s ease-out forwards;
  z-index: 30;
  pointer-events: none;
  background: rgba(255,255,255,0.9);
  padding: 2px 8px;
  border-radius: 6px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}
.delta-up   { color: #2CA052; border: 1px solid #2CA052; }
.delta-down { color: var(--accent); border: 1px solid var(--accent); }
@keyframes deltaAnim {
  0%   { opacity:1; transform:translateY(0); }
  70%  { opacity:1; }
  100% { opacity:0; transform:translateY(-22px); }
}

/* ‚îÄ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ‚îÄ */
.footer {
  position: relative; z-index: 10;
  background: #fff;
  border-top: 2px solid #E4E8EE;
  padding: 7px 36px;
  display: flex;
  align-items: center;
  gap: 16px;
  display: none;
}
.footer-label {
  font-family:'Barlow', sans-serif;
  font-size: 12px;
  color: var(--text-light);
  white-space: nowrap;
  flex-shrink:0;
}
.progress-track {
  flex:1;
  height: 4px;
  background: #E4E8EE;
  border-radius: 3px;
  overflow: hidden;
}
.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent), #F07060);
  border-radius: 3px;
  width: 0%;
  transition: width 1s linear;
}
.footer-right {
  display: flex;
  align-items: center;
  gap: 12px;
  flex-shrink: 0;
}
.count-badge {
  background: #F3F5F7;
  border: 1px solid #E0E4E9;
  border-radius: 8px;
  padding: 3px 10px;
  font-size: 12px;
  color: var(--text-mid);
  font-family: 'Barlow', sans-serif;
}
.settings-btn {
  background: transparent;
  border: 1.5px solid #D0D5DB;
  border-radius: 8px;
  color: var(--text-light);
  padding: 4px 12px;
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 13px;
  font-weight: 600;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  cursor: pointer;
  transition: all 0.15s;
}
.settings-btn:hover { border-color: var(--text-mid); color: var(--text-mid); }

/* ‚îÄ‚îÄ‚îÄ CONFETTI ‚îÄ‚îÄ‚îÄ */
.confetti { position:fixed; pointer-events:none; z-index:997; border-radius:2px; animation:confettiFall linear forwards; }
@keyframes confettiFall {
  0%  { transform:translateY(-30px) rotate(0deg); opacity:1; }
  100%{ transform:translateY(105vh) rotate(600deg); opacity:0; }
}

@keyframes cloudDrift {
  from { transform: translateX(-200px); }
  to   { transform: translateX(110vw); }
}
</style>
</head>
<body>

<!-- CLOUDS -->
<div class="clouds" id="clouds"></div>

<!-- CONFIG -->
<div class="config-overlay" id="configOverlay">
  <div class="config-box">
    <h2>‚ö° SERVICE SPEED LEAGUE</h2>
    <p class="sub">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Google Sheets –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ä–¥</p>

    <div class="form-group">
      <label>Google Sheets ID</label>
      <input id="sheetId" type="text" value="1NHrU5fNogX2siHzIUKpQer5PrfH8lQm_ZcnBzKTanHs" />
      <div class="form-hint">
        –ò–∑ URL —Ç–∞–±–ª–∏—Ü—ã: docs.google.com/spreadsheets/d/<b>–≠–¢–û–¢_ID</b>/edit<br>
        –¢–∞–±–ª–∏—Ü–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç–∞: <b>–§–∞–π–ª ‚Üí –û–±—â–∏–π –¥–æ—Å—Ç—É–ø ‚Üí –í—Å–µ, —É –∫–æ–≥–æ –µ—Å—Ç—å —Å—Å—ã–ª–∫–∞</b>
      </div>
    </div>

    <div class="form-group">
      <label>–ù–∞–∑–≤–∞–Ω–∏–µ –ª–∏—Å—Ç–∞</label>
      <input id="sheetName" type="text" value="–õ–∏—Å—Ç1" />
      <div class="form-hint">
        –ö–æ–ª–æ–Ω–∫–∏ –Ω–∞ –ª–∏—Å—Ç–µ: <b>A = –ò–º—è</b>, <b>B = –û—Ü–µ–Ω–∫–∞</b> (–ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ ‚Äî –∑–∞–≥–æ–ª–æ–≤–∫–∏)
      </div>
    </div>

    <div id="errMsg" class="error"></div>

    <button class="btn-primary" onclick="startBoard()">üö¶ –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ä–¥</button>
    <button class="btn-secondary" onclick="startDemo()">‚ñ∂ –î–µ–º–æ-—Ä–µ–∂–∏–º (–±–µ–∑ —Ç–∞–±–ª–∏—Ü—ã)</button>
  </div>
</div>

<!-- HEADER -->
<div class="header" id="headerEl">
  <div class="header-left">
    <span class="rally-flag">üèÅ</span>
    <div>
      <div class="header-title">‚ö° SERVICE SPEED LEAGUE</div>
      <div class="header-sub">–ö—Ç–æ –±—ã—Å—Ç—Ä–µ–µ –≤—Å–µ—Ö –ø—Ä–∏–Ω–æ—Å–∏—Ç –∫–∞–π—Ñ –∫–ª–∏–µ–Ω—Ç–∞–º? üèÜ –û—Ç–¥–µ–ª —Å–µ—Ä–≤–∏—Å–∞ ‚Äî —Ä–µ–π—Ç–∏–Ω–≥ –∫–∞—á–µ—Å—Ç–≤–∞</div>
    </div>
  </div>
  <div class="header-right">
    <div>–û–±–Ω–æ–≤–ª–µ–Ω–æ: <span id="lastUpdate">‚Äî</span></div>
    <div class="live-badge"><span class="live-dot"></span>LIVE</div>
  </div>
</div>

<!-- TRACK AREA -->
<div class="track-area" id="trackArea"></div>

<!-- FOOTER -->
<div class="footer" id="footerEl">
  <span class="footer-label">–°–ª–µ–¥—É—é—â–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ <b><span id="countdown">300</span>—Å</b></span>
  <div class="progress-track"><div class="progress-fill" id="progressFill"></div></div>
  <div class="footer-right">
    <span class="count-badge" id="opCount">0 –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤</span>
    <button class="settings-btn" onclick="showConfig()">‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
  </div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ CLOUD GENERATOR ‚îÄ‚îÄ‚îÄ
(function() {
  const cont = document.getElementById('clouds');
  const defs = [
    {w:200,h:50,top:15,dur:55,delay:-10},
    {w:140,h:38,top:30,dur:70,delay:-30},
    {w:170,h:44,top:8, dur:62,delay:-45},
    {w:110,h:32,top:40,dur:80,delay:-20},
    {w:220,h:52,top:20,dur:50,delay:-60},
  ];
  defs.forEach(d => {
    const el = document.createElement('div');
    el.className = 'cloud';
    el.style.cssText = `width:${d.w}px;height:${d.h}px;top:${d.top}px;opacity:0.75;
      animation-duration:${d.dur}s;animation-delay:${d.delay}s;`;
    el.style.setProperty('--drift', `${d.dur}s`);
    // puffballs
    el.innerHTML = `
      <div style="position:absolute;width:${d.w*0.45}px;height:${d.h*1.4}px;
        background:rgba(255,255,255,0.85);border-radius:50%;top:-40%;left:20%"></div>
      <div style="position:absolute;width:${d.w*0.35}px;height:${d.h*1.2}px;
        background:rgba(255,255,255,0.85);border-radius:50%;top:-25%;left:45%"></div>`;
    cont.appendChild(el);
  });
})();

// ‚îÄ‚îÄ‚îÄ CAR SVG BUILDER ‚îÄ‚îÄ‚îÄ
const CAR_PALETTES = [
  {body:'#CC2200', roof:'#991A00', rim:'#CCCCCC', num:'#fff'},  // 1 red
  {body:'#1155CC', roof:'#0C3D99', rim:'#DDDDDD', num:'#fff'},  // 2 blue
  {body:'#228833', roof:'#165C22', rim:'#CCCCCC', num:'#fff'},  // 3 green
  {body:'#FF8800', roof:'#CC6600', rim:'#FFFFFF', num:'#fff'},  // 4 orange
  {body:'#7733CC', roof:'#551A99', rim:'#DDDDDD', num:'#fff'},  // 5 purple
  {body:'#008899', roof:'#006677', rim:'#CCCCCC', num:'#fff'},  // 6 teal
  {body:'#CC8800', roof:'#997700', rim:'#FFFFFF', num:'#fff'},  // 7 gold
  {body:'#AA2266', roof:'#881A55', rim:'#DDDDDD', num:'#fff'},  // 8 pink
  {body:'#334455', roof:'#22334A', rim:'#CCCCCC', num:'#fff'},  // 9 slate
  {body:'#EE6622', roof:'#BB4411', rim:'#FFFFFF', num:'#fff'},  // 10 tangerine
  {body:'#00BBAA', roof:'#008877', rim:'#FFFFFF', num:'#fff'},  // 11 cyan
  {body:'#FF4488', roof:'#CC1155', rim:'#FFFFFF', num:'#fff'},  // 12 hot pink
  {body:'#AACC00', roof:'#778800', rim:'#FFFFFF', num:'#fff'},  // 13 lime
  {body:'#5599FF', roof:'#2266CC', rim:'#FFFFFF', num:'#fff'},  // 14 sky blue
  {body:'#FF7733', roof:'#CC4400', rim:'#FFFFFF', num:'#fff'},  // 15 deep orange
];

function buildCar(rank, size) {
  const p = CAR_PALETTES[(rank-1) % CAR_PALETTES.length];
  const W = size, H = Math.round(size * 0.52);
  // SVG rally hatchback silhouette
  return `<svg class="car-body" width="${W}" height="${H}" viewBox="0 0 90 47" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <linearGradient id="bd${rank}" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="${p.body}"/>
      <stop offset="100%" stop-color="${p.roof}"/>
    </linearGradient>
    <linearGradient id="wb${rank}" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="rgba(200,235,255,0.8)"/>
      <stop offset="100%" stop-color="rgba(140,200,240,0.5)"/>
    </linearGradient>
    <filter id="ds${rank}"><feDropShadow dx="1" dy="2" stdDeviation="2" flood-opacity="0.3"/></filter>
  </defs>
  <!-- Underbody -->
  <rect x="6" y="32" width="78" height="7" rx="3" fill="${p.roof}" opacity="0.6"/>
  <!-- Main body -->
  <path d="M8 38 Q6 32 8 26 L16 26 Q20 14 32 11 L58 11 Q70 12 76 22 L82 24 Q85 26 85 32 L84 38 Z"
        fill="url(#bd${rank})" filter="url(#ds${rank})"/>
  <!-- Roof -->
  <path d="M28 25 Q32 11 38 10 L54 10 Q62 10 64 19 L68 25 Z" fill="${p.roof}" opacity="0.9"/>
  <!-- Hood vents -->
  <rect x="60" y="20" width="12" height="2" rx="1" fill="rgba(0,0,0,0.25)"/>
  <rect x="60" y="23" width="10" height="1.5" rx="1" fill="rgba(0,0,0,0.2)"/>
  <!-- Side stripe -->
  <rect x="10" y="30" width="65" height="3" rx="1.5" fill="rgba(255,255,255,0.22)"/>
  <!-- Windshield -->
  <path d="M30 25 Q33 13 38 11 L54 11 Q60 12 62 20 L64 25 Z" fill="url(#wb${rank})" stroke="rgba(255,255,255,0.4)" stroke-width="0.7"/>
  <!-- Side window -->
  <path d="M20 25 Q22 16 27 13 L30 11 L30 11 L28 25 Z" fill="url(#wb${rank})" opacity="0.6"/>
  <!-- Headlight -->
  <ellipse cx="82" cy="28" rx="3.5" ry="2.5" fill="rgba(255,250,180,0.95)" filter="url(#ds${rank})"/>
  <ellipse cx="82" cy="28" rx="2" ry="1.5" fill="#fff"/>
  <!-- Taillight -->
  <rect x="8" y="26" width="4" height="6" rx="1.5" fill="rgba(255,50,30,0.9)"/>
  <rect x="8.5" y="26.5" width="3" height="2.5" rx="1" fill="rgba(255,180,150,0.7)"/>
  <!-- Number plate on roof -->
  <rect x="35" y="13" width="20" height="9" rx="2" fill="rgba(255,255,255,0.9)" stroke="${p.body}" stroke-width="0.8"/>
  <text x="45" y="20" text-anchor="middle" font-family="Barlow Condensed,sans-serif" font-weight="900" font-size="7" fill="${p.body}">${rank}</text>
  <!-- Door seam -->
  <line x1="47" y1="26" x2="47" y2="37" stroke="rgba(0,0,0,0.18)" stroke-width="1"/>
  <!-- Front wheel -->
  <circle class="wheel-spin" cx="66" cy="40" r="7" fill="#222" stroke="${p.rim}" stroke-width="2"/>
  <circle cx="66" cy="40" r="3.5" fill="#555" stroke="rgba(255,255,255,0.25)" stroke-width="1"/>
  <line x1="66" y1="35" x2="66" y2="45" stroke="${p.rim}" stroke-width="1" opacity="0.6"/>
  <line x1="61" y1="40" x2="71" y2="40" stroke="${p.rim}" stroke-width="1" opacity="0.6"/>
  <!-- Rear wheel -->
  <circle class="wheel-spin" cx="24" cy="40" r="7" fill="#222" stroke="${p.rim}" stroke-width="2"/>
  <circle cx="24" cy="40" r="3.5" fill="#555" stroke="rgba(255,255,255,0.25)" stroke-width="1"/>
  <line x1="24" y1="35" x2="24" y2="45" stroke="${p.rim}" stroke-width="1" opacity="0.6"/>
  <line x1="19" y1="40" x2="29" y2="40" stroke="${p.rim}" stroke-width="1" opacity="0.6"/>
  <!-- Roof rack / spoiler -->
  <rect x="22" y="9.5" width="38" height="2" rx="1" fill="${p.roof}" opacity="0.7"/>
  <!-- Mud flaps -->
  <rect x="16" y="35" width="4" height="5" rx="1" fill="rgba(0,0,0,0.4)"/>
  <rect x="72" y="35" width="4" height="5" rx="1" fill="rgba(0,0,0,0.4)"/>
</svg>`;
}

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ
let cfg = {};
let prevRanks = {};
let refreshTimer = null, cdTimer = null, cdVal = 300;

// ‚îÄ‚îÄ‚îÄ DEMO DATA ‚îÄ‚îÄ‚îÄ
const DEMO = [
  {name:'–°–∞–º–∞—Ä–±–µ–∫–æ–≤–∞ –ê.',   score:99.4},
  {name:'–ê–∑–∞–º–∞—Ç–æ–≤–∞ –°.',     score:98.6},
  {name:'–°–∞–ª–ø–∏–µ–≤ –≠.',       score:98.5},
  {name:'–¢—É—Ä–≥–∞–Ω–±–∞–µ–≤–∞ –ê.',   score:98.0},
  {name:'–ñ–∞–±–∞–π —É—É–ª—É –ê.',    score:98.1},
  {name:'–ê–ª–º–∞—Å–±–µ–∫–æ–≤–∞ –ö.',   score:97.0},
  {name:'–ê–ª–∏–ø—Å–∞—Ç–∞—Ä–æ–≤ –ë.',   score:96.9},
  {name:'–≠—Ä–Ω–∏—Å —É—É–ª—É –ú.',    score:96.3},
  {name:'–ê–π—Ç–±–µ–∫–æ–≤–∞ –ê.',     score:96.3},
  {name:'–ö–æ–∂–æ—à–æ–≤–∞ –¢.',      score:95.6},
  {name:'–£–ª–∞–Ω–±–µ–∫ —É—É–ª—É –ó.',  score:94.5},
  {name:'–ê—Ö–º–∞–¥–±–µ–∫–æ–≤ –ê.',    score:94.3},
  {name:'–î–∂—É–Ω—É—Å–æ–≤ –¢.',      score:94.2},
  {name:'–°–∞—è–∫–æ–≤–∞ –ê.',       score:94.1},
  {name:'–ë–∞–π—Ç–∏–∫–æ–≤–∞ –ì.',     score:92.6},
  {name:'–°—ã–π–¥–∞–ª—ã–µ–≤ –ê.',     score:92.9},
  {name:'–ê–±–¥—ã—Ä–∞–∫–º–∞–Ω–æ–≤–∞ –ê.', score:92.4},
  {name:'–ê—Å–∞–Ω–∞–ª–∏–µ–≤ –ê.',     score:91.9},
  {name:'–ê–º–∞–Ω–±–∞–µ–≤–∞ –≠.',     score:91.9},
  {name:'–°—É–ª—Ç–∞–Ω–æ–≤ –ë.',      score:88.8},
  {name:'–ö–æ—á–∫–æ—Ä–æ–≤ –ê.',      score:86.9},
  {name:'–°–∞–ª–∏–µ–≤ –ê.',        score:85.9},
  {name:'–°–∞–ª–∞—Ö–æ–¥–∂–∞–µ–≤ –ê.',   score:85.3},
  {name:'–ë–∞–ª–±–∞–µ–≤ –•.',       score:84.9},
  {name:'–ê–∫—ã–ª–±–µ–∫ –∫. –ê.',    score:84.6},
  {name:'–ú–∞–º–∞—Ç–æ–≤–∞ –ê.',      score:83.8},
  {name:'–ú—ã—Ä–∑–∞–±–∞—è–ª–∏–µ–≤ –ë.',  score:83.1},
  {name:'–ò–¥—Ä–∏—Å–æ–≤ –ù.',       score:82.9},
  {name:'–≠—Ä–Ω–∞–∑–∞—Ä–æ–≤–∞ –°.',    score:83.0},
  {name:'–¢—É–∑–∞–±–∞–µ–≤ –ê.',      score:80.7},
  {name:'–ê–ª—Ç—ã–Ω–∫–∞–∑—ã –∫. –ê.',  score:81.0},
  {name:'–¢—ã–Ω—á–∏–µ–≤ –ë.',       score:78.7},
  {name:'–ñ—É–Ω—É—Å–æ–≤–∞ –ê.',      score:79.3},
  {name:'–ö–∞–Ω–∞—Ç–æ–≤–∞ –ê.',      score:77.6},
  {name:'–†–∞–≤—à–∞–Ω–±–µ–∫ —É—É–ª—É –ú.',score:69.8},
  {name:'–ê–ª—ã–º–±–∞–µ–≤–∞ –ë.',     score:59.8},
  {name:'–î–∞–ª–∏–µ–≤–∞ –°.',       score:59.0},
  {name:'–ö–∞—Å—ã–º–±–µ–∫–æ–≤ –ê.',    score:36.0},
];

// ‚îÄ‚îÄ‚îÄ FETCH FROM SHEETS via JSONP (works from file://) ‚îÄ‚îÄ‚îÄ
function fetchSheet(id, sheetName) {
  return new Promise((resolve, reject) => {
    // Remove any previous JSONP script/callback
    const oldScript = document.getElementById('gsheets-jsonp');
    if (oldScript) oldScript.remove();
    if (window.__gsheetsCallback) delete window.__gsheetsCallback;

    const cbName = '__gsheetsCallback';
    const timeout = setTimeout(() => {
      delete window[cbName];
      reject(new Error('Timeout ‚Äî —Ç–∞–±–ª–∏—Ü–∞ –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª–∞ –∑–∞ 10 —Å–µ–∫—É–Ω–¥'));
    }, 10000);

    window[cbName] = function(json) {
      clearTimeout(timeout);
      delete window[cbName];
      try {
        const rows = json.table.rows || [];
        const result = [];
        for (const row of rows) {
          if (!row.c || !row.c[0] || row.c[0].v == null) continue;
          const name = String(row.c[0].v).trim();
          const score = parseFloat(row.c[1]?.v);
          // Skip totals/summary rows
          if (name && !isNaN(score) && name !== '–ò—Ç–æ–≥–æ' && name !== '–ò–¢–û–ì–û' && name !== '–∏—Ç–æ–≥–æ') result.push({name, score});
        }
        const sorted = result.sort((a,b) => b.score - a.score).slice(0, 15);
        if (sorted.length === 0) reject(new Error('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–∞–±–ª–∏—Ü–µ'));
        else resolve(sorted);
      } catch(e) { reject(e); }
    };

    const url = `https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:json&callback=${cbName}&sheet=${encodeURIComponent(sheetName)}`;
    const script = document.createElement('script');
    script.id = 'gsheets-jsonp';
    script.src = url;
    script.onerror = () => {
      clearTimeout(timeout);
      delete window[cbName];
      reject(new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Google Sheets'));
    };
    document.head.appendChild(script);
  });
}

// ‚îÄ‚îÄ‚îÄ SCORE COLORS ‚îÄ‚îÄ‚îÄ
function scoreColor(s, max, min) {
  const t = max === min ? 1 : (s - min) / (max - min);
  if (t > 0.85) return '#1A8A40';
  if (t > 0.60) return '#2A7ABF';
  if (t > 0.35) return '#E07A00';
  return '#CC2200';
}

// ‚îÄ‚îÄ‚îÄ CALCULATE CAR POSITION ‚îÄ‚îÄ‚îÄ
function carPos(score, maxS, minS, raceW, leftW) {
  const range = maxS === minS ? 1 : maxS - minS;
  const t = (score - minS) / range;           // 0..1
  const minFraction = 0.1;
  return leftW + (minFraction + t * (1 - minFraction)) * raceW;
}

// ‚îÄ‚îÄ‚îÄ CAR SIZE BASED ON LANE HEIGHT ‚îÄ‚îÄ‚îÄ
function carSize(laneH) { return Math.round(Math.min(laneH * 1.7, 86)); }

// ‚îÄ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ
function renderBoard(data) {
  const track = document.getElementById('trackArea');
  const isFirst = !track.querySelector('.race-lane');

  document.getElementById('opCount').textContent = data.length + ' –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤';
  document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('ru-RU');

  const maxS = Math.max(...data.map(d=>d.score));
  const minS = Math.min(...data.map(d=>d.score));

  if (isFirst) {
    track.innerHTML = '';
    data.forEach((op, i) => track.appendChild(buildLane(op, i+1, maxS, minS)));
    requestAnimationFrame(() => {
      data.forEach((op, i) => {
        setTimeout(() => animateCar(i+1, op.score, maxS, minS), 120 + i * 100);
      });
    });
  } else {
    const newRanks = {};
    data.forEach((op,i) => { newRanks[op.name] = i+1; });

    data.forEach((op, i) => {
      const rank = i+1;
      const prev = prevRanks[op.name];
      if (prev && prev !== rank) showDelta(rank, prev - rank);
    });

    data.forEach((op, i) => {
      const rank = i+1;
      const lane = track.querySelector(`[data-rank="${rank}"]`);
      if (!lane) return;
      lane.querySelector('.op-name').textContent = op.name;
      const sEl = lane.querySelector('.score-num');
      sEl.textContent = op.score.toFixed(1);
      sEl.style.color = scoreColor(op.score, maxS, minS);
      const fill = lane.querySelector('.score-bar-fill');
      const t = maxS===minS ? 1 : (op.score-minS)/(maxS-minS);
      fill.style.width = (30 + t*70) + '%';
      fill.style.background = scoreColor(op.score, maxS, minS);
      animateCar(rank, op.score, maxS, minS);
    });

    // confetti if new leader
    const newLeader = data[0]?.name;
    if (newLeader && prevRanks[newLeader] && prevRanks[newLeader] > 1) confetti();
  }

  prevRanks = {};
  data.forEach((op,i) => { prevRanks[op.name] = i+1; });
}

function buildLane(op, rank, maxS, minS) {
  const div = document.createElement('div');
  div.className = 'race-lane';
  div.setAttribute('data-rank', rank);

  const posClass = rank <= 3 ? `pos-${rank}` : 'pos-other';
  const rankLabel = rank <= 3 ? ['ü•á','ü•à','ü•â'][rank-1] : '#' + rank;
  const t = maxS === minS ? 1 : (op.score - minS)/(maxS - minS);
  const barW = Math.round(30 + t * 70);
  const col = scoreColor(op.score, maxS, minS);

  div.innerHTML = `
    <div class="lane-grass-top"></div>
    <div class="track-surface"><div class="road-dashes"></div></div>
    <div class="lane-grass-bot"></div>
    <div class="barrier"></div>
    <div class="finish-zone"><div class="finish-checker"></div><div class="finish-glow"></div></div>
    <div class="lane-left">
      <div class="rank-plate ${posClass}">${rankLabel}</div>
      <div>
        <div class="op-name">${op.name}</div>
      </div>
    </div>
    <div class="car-wrapper" id="car-${rank}">
      <div class="dust-trail">
        <div class="dust"></div>
        <div class="dust"></div>
        <div class="dust"></div>
      </div>
      ${buildCar(rank, 80)}
    </div>
    <div class="lane-right">
      <div class="score-num" style="color:${col}">${op.score.toFixed(1)}</div>
      <div class="score-bar-wrap">
        <div class="score-bar-fill" style="width:${barW}%;background:${col}"></div>
      </div>
      <div class="score-label">–∏–∑ 100</div>
    </div>`;

  // Initial car position (behind barrier)
  const carEl = div.querySelector(`#car-${rank}`);
  carEl.style.left = '210px';
  return div;
}

function animateCar(rank, score, maxS, minS) {
  const track = document.getElementById('trackArea');
  const carEl = document.getElementById('car-' + rank);
  if (!carEl) return;
  const lane = carEl.closest('.race-lane');
  if (!lane) return;

  const trackW = track.clientWidth;
  const leftW  = 306;   // left panel
  const rightW = 148;   // right panel
  const finishX = trackW - rightW - 28;
  const raceW = finishX - leftW;

  const targetLeft = carPos(score, maxS, minS, raceW, leftW);
  const finishThreshold = finishX - 10;

  carEl.classList.add('is-moving');
  carEl.style.left = targetLeft + 'px';

  setTimeout(() => {
    carEl.classList.remove('is-moving');
    if (targetLeft >= finishThreshold) {
      carEl.classList.add('car-idle');
    } else {
      carEl.classList.remove('car-idle');
    }
  }, 1500);
}

function showDelta(rank, delta) {
  const lane = document.querySelector(`[data-rank="${rank}"]`);
  if (!lane) return;
  const el = document.createElement('div');
  el.className = 'rank-delta ' + (delta > 0 ? 'delta-up' : 'delta-down');
  el.textContent = delta > 0 ? '‚ñ≤ +' + delta : '‚ñº ' + delta;
  lane.appendChild(el);
  setTimeout(() => el.remove(), 2300);
}

function confetti() {
  const colors = ['#CC2200','#1155CC','#228833','#FF8800','#E8A000','#7733CC'];
  for (let i = 0; i < 70; i++) {
    setTimeout(() => {
      const el = document.createElement('div');
      el.className = 'confetti';
      el.style.cssText = `left:${15+Math.random()*70}vw;width:${6+Math.random()*6}px;height:${6+Math.random()*6}px;
        background:${colors[Math.floor(Math.random()*colors.length)]};
        animation-duration:${1.8+Math.random()*2}s;animation-delay:${Math.random()*0.6}s;`;
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 5000);
    }, i * 25);
  }
}

// ‚îÄ‚îÄ‚îÄ COUNTDOWN ‚îÄ‚îÄ‚îÄ
function startCountdown(secs) {
  clearInterval(cdTimer);
  cdVal = secs;
  const fill = document.getElementById('progressFill');
  const cd   = document.getElementById('countdown');
  cd.textContent = cdVal;
  cdTimer = setInterval(() => {
    cdVal--;
    cd.textContent = Math.max(0, cdVal);
    fill.style.width = ((secs - cdVal) / secs * 100) + '%';
    if (cdVal <= 0) clearInterval(cdTimer);
  }, 1000);
}

// ‚îÄ‚îÄ‚îÄ LOAD & RENDER ‚îÄ‚îÄ‚îÄ
async function loadAndRender() {
  if (cfg.demo) {
    const data = DEMO.map(d => ({
      name: d.name,
      score: Math.max(30, Math.min(100, d.score + (Math.random()-.5)*1.5))
    })).sort((a,b) => b.score - a.score);
    renderBoard(data);
    startCountdown(15);
    return;
  }
  try {
    const data = await fetchSheet(cfg.sheetId, cfg.sheetName);
    if (!data.length) throw new Error('empty');
    document.getElementById('errMsg').style.display = 'none';
    renderBoard(data);
    startCountdown(cfg.interval);
  } catch(e) {
    const em = document.getElementById('errMsg');
    em.style.display = 'block';
    const msg = e.message || '';
    if (msg.includes('Timeout')) {
      em.textContent = '‚ùå –¢–∞–±–ª–∏—Ü–∞ –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ ID –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –ª–∏—Å—Ç–∞.';
    } else if (msg.includes('empty') || msg.includes('–¥–∞–Ω–Ω—ã—Ö')) {
      em.textContent = '‚ùå –¢–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞—è –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –ª–∏—Å—Ç–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ: A=–ò–º—è, B=–û—Ü–µ–Ω–∫–∞, –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ ‚Äî –∑–∞–≥–æ–ª–æ–≤–∫–∏.';
    } else {
      em.textContent = '‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –£–±–µ–¥–∏—Ç–µ—Å—å: –¥–æ—Å—Ç—É–ø –æ—Ç–∫—Ä—ã—Ç ‚Üí "–í—Å–µ —Å —Å—Å—ã–ª–∫–æ–π" ‚Üí "–ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—é—â–∏–π", ID –∏ –∏–º—è –ª–∏—Å—Ç–∞ –≤–µ—Ä–Ω—ã–µ.';
    }
    if (!document.querySelector('.race-lane')) showConfig();
  }
}

// ‚îÄ‚îÄ‚îÄ UI FLOW ‚îÄ‚îÄ‚îÄ
function showBoard() {
  document.getElementById('configOverlay').style.display = 'none';
  document.getElementById('headerEl').style.display = 'flex';
  document.getElementById('trackArea').style.display = 'flex';
  document.getElementById('footerEl').style.display = 'flex';
}

function showConfig() {
  document.getElementById('configOverlay').style.display = 'flex';
}

async function startBoard() {
  const id = document.getElementById('sheetId').value.trim();
  const sn = document.getElementById('sheetName').value.trim() || '–õ–∏—Å—Ç1';
  if (!id) {
    const em = document.getElementById('errMsg');
    em.style.display = 'block';
    em.textContent = '‚ùå –í–≤–µ–¥–∏—Ç–µ ID —Ç–∞–±–ª–∏—Ü—ã Google Sheets';
    return;
  }
  cfg = { sheetId: id, sheetName: sn, interval: 300, demo: false };
  showBoard();
  await loadAndRender();
  clearInterval(refreshTimer);
  refreshTimer = setInterval(loadAndRender, 300_000);
  setTimeout(startAutoScroll, 2000);
}

function startDemo() {
  cfg = { interval: 15, demo: true };
  showBoard();
  loadAndRender();
  clearInterval(refreshTimer);
  refreshTimer = setInterval(loadAndRender, 15_000);
  setTimeout(startAutoScroll, 2000);
}

// ‚îÄ‚îÄ‚îÄ RESIZE: reposition cars ‚îÄ‚îÄ‚îÄ
window.addEventListener('resize', () => {
  if (!document.querySelector('.race-lane')) return;
  document.querySelectorAll('.race-lane').forEach(lane => {
    const rank = parseInt(lane.getAttribute('data-rank'));
    const sEl  = lane.querySelector('.score-num');
    if (!sEl) return;
    const score = parseFloat(sEl.textContent);
    const all = [...document.querySelectorAll('.race-lane')].map(l => parseFloat(l.querySelector('.score-num').textContent));
    animateCar(rank, score, Math.max(...all), Math.min(...all));
  });
});

// ‚îÄ‚îÄ‚îÄ AUTO-SCROLL for many operators ‚îÄ‚îÄ‚îÄ
let scrollDir = 1, scrollPos = 0, scrollPaused = false;
function startAutoScroll() {
  const area = document.getElementById('trackArea');
  if (!area) return;
  setInterval(() => {
    if (scrollPaused) return;
    const maxScroll = area.scrollHeight - area.clientHeight;
    if (maxScroll <= 0) return;
    scrollPos += scrollDir * 0.6;
    if (scrollPos >= maxScroll) { scrollPos = maxScroll; scrollDir = -1; scrollPaused = true; setTimeout(()=>{ scrollPaused=false; }, 2500); }
    if (scrollPos <= 0) { scrollPos = 0; scrollDir = 1; scrollPaused = true; setTimeout(()=>{ scrollPaused=false; }, 2500); }
    area.scrollTop = scrollPos;
  }, 30);
}

// ‚îÄ‚îÄ‚îÄ AUTOSTART on page load ‚îÄ‚îÄ‚îÄ
window.addEventListener('DOMContentLoaded', () => {
  // Auto-launch with pre-configured sheet ‚Äî no setup needed
  cfg = {
    sheetId: '1NHrU5fNogX2siHzIUKpQer5PrfH8lQm_ZcnBzKTanHs',
    sheetName: '–õ–∏—Å—Ç1',
    interval: 300,
    demo: false
  };
  showBoard();
  loadAndRender().then(() => {
    clearInterval(refreshTimer);
    refreshTimer = setInterval(loadAndRender, 300_000);
    setTimeout(startAutoScroll, 2500);
  });
});
</script>
</body>
</html>
